<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××•×¦×¨×™× - ××¢×¨×›×ª ×©×•×‘×¨×™×</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Assistant', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #f0f0f0;
        }
        .navbar {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .navbar h1 { color: #FFD700; font-size: 1.5rem; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a {
            color: #ddd;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .nav-links a:hover, .nav-links a.active {
            background: rgba(255,215,0,0.2);
            color: #FFD700;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h2 { font-size: 1.8rem; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,215,0,0.4); }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        .btn-danger {
            background: rgba(220,53,69,0.8);
            color: #fff;
        }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        .product-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s;
        }
        .product-card:hover { transform: translateY(-5px); }
        .product-card.inactive { opacity: 0.6; }
        .product-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: rgba(0,0,0,0.3);
        }
        .product-content { padding: 20px; }
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .product-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
        }
        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #FFD700;
        }
        .product-description {
            color: #aaa;
            font-size: 0.95rem;
            margin-bottom: 15px;
            min-height: 40px;
        }
        .product-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .badge-active { background: rgba(34,197,94,0.2); color: #22c55e; }
        .badge-inactive { background: rgba(239,68,68,0.2); color: #ef4444; }
        .badge-premium { background: rgba(255,215,0,0.2); color: #FFD700; }
        .product-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal {
            background: #1a1a2e;
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header h3 { font-size: 1.4rem; color: #FFD700; }
        .close-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .modal-body { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
            font-weight: 500;
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #FFD700;
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        .hidden { display: none !important; }
        .emoji-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .emoji-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .emoji-option:hover { background: rgba(255,255,255,0.2); }
        .emoji-option.selected { border-color: #FFD700; background: rgba(255,215,0,0.2); }
        
        .image-upload-container { display: flex; flex-direction: column; gap: 12px; }
        .image-preview {
            width: 100%;
            height: 150px;
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
        }
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .image-preview .no-image { color: #666; font-size: 0.9rem; }
        .image-upload-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .upload-btn { cursor: pointer; }
        .upload-btn:hover { background: rgba(255,255,255,0.15); }
        .uploading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>ğŸ ××¢×¨×›×ª ×©×•×‘×¨×™×</h1>
        <div class="nav-links">
            <a href="/admin/">×©×•×‘×¨×™×</a>
            <a href="/admin/products" class="active">××•×¦×¨×™×</a>
            <a href="/admin/users">××©×ª××©×™×</a>
            <a href="/" target="_blank">×œ××ª×¨</a>
            <a href="#" onclick="logout()">×™×¦×™××”</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h2>× ×™×”×•×œ ××•×¦×¨×™×</h2>
            <button class="btn btn-primary" onclick="openAddModal()">
                <span>+</span> ×”×•×¡×£ ××•×¦×¨
            </button>
        </div>

        <div class="products-grid" id="productsGrid">
            <p style="color:#888">×˜×•×¢×Ÿ ××•×¦×¨×™×...</p>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay hidden" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">×”×•×¡×¤×ª ××•×¦×¨</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="form-group">
                        <label>×©× ×”××•×¦×¨ *</label>
                        <input type="text" class="form-input" id="productName" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>××—×™×¨ (â‚ª) *</label>
                            <input type="number" class="form-input" id="productPrice" required>
                        </div>
                        <div class="form-group">
                            <label>×¡×“×¨ ×ª×¦×•×’×”</label>
                            <input type="number" class="form-input" id="productOrder" value="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>×ª×™××•×¨</label>
                        <textarea class="form-textarea" id="productDescription"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>×ª××•× ×”</label>
                        <div class="image-upload-container">
                            <div class="image-preview" id="imagePreview">
                                <span class="no-image">××™×Ÿ ×ª××•× ×”</span>
                            </div>
                            <div class="image-upload-actions">
                                <label class="btn btn-secondary btn-small upload-btn">
                                    <input type="file" id="imageFile" accept="image/*" style="display:none">
                                    ğŸ“¤ ×”×¢×œ×” ×ª××•× ×”
                                </label>
                                <button type="button" class="btn btn-secondary btn-small" onclick="toggleUrlInput()">ğŸ”— ××• ×§×™×©×•×¨</button>
                                <button type="button" class="btn btn-danger btn-small hidden" id="removeImageBtn" onclick="removeImage()">ğŸ—‘ï¸ ×”×¡×¨</button>
                            </div>
                            <input type="url" class="form-input hidden" id="productImage" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>×§×™×©×•×¨ ×œ×“×£ ×¡×œ×™×§×”</label>
                        <input type="url" class="form-input" id="productPaymentUrl" placeholder="https://meshulam.co.il/...">
                    </div>
                    
                    <div class="form-group">
                        <label>××™×™×§×•×Ÿ</label>
                        <div class="emoji-picker" id="emojiPicker">
                            <div class="emoji-option" data-emoji="ğŸ">ğŸ</div>
                            <div class="emoji-option" data-emoji="â˜•">â˜•</div>
                            <div class="emoji-option" data-emoji="ğŸ³">ğŸ³</div>
                            <div class="emoji-option" data-emoji="ğŸ’">ğŸ’</div>
                            <div class="emoji-option" data-emoji="ğŸ‘‘">ğŸ‘‘</div>
                            <div class="emoji-option" data-emoji="ğŸŒ¿">ğŸŒ¿</div>
                            <div class="emoji-option" data-emoji="ğŸŒ¸">ğŸŒ¸</div>
                            <div class="emoji-option" data-emoji="âœ¨">âœ¨</div>
                        </div>
                        <input type="hidden" id="productIcon" value="ğŸ">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="productActive" checked>
                                <label for="productActive">××•×¦×¨ ×¤×¢×™×œ</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="productPremium">
                                <label for="productPremium">××•×¦×¨ ×¤×¨×™××™×•×</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveProduct()">×©××•×¨</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay hidden" id="deleteModal">
        <div class="modal" style="max-width:400px">
            <div class="modal-header">
                <h3>××—×™×§×ª ××•×¦×¨</h3>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××•×¦×¨ "<span id="deleteProductName"></span>"?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-danger" onclick="confirmDelete()">××—×§</button>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let products = [];
        let deleteProductId = null;
        let selectedEmoji = 'ğŸ';
        let currentImageUrl = '';
        let uploadedImageUrl = null;

        // Check auth
        checkAuth();

        async function checkAuth() {
            try {
                const res = await fetch(`${API}/auth/me`, { credentials: 'include' });
                if (!res.ok) {
                    window.location.href = '/admin/login';
                } else {
                    loadProducts();
                }
            } catch {
                window.location.href = '/admin/login';
            }
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API}/products/all`, { credentials: 'include' });
                products = await res.json();
                renderProducts();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                grid.innerHTML = '<p style="color:#888">××™×Ÿ ××•×¦×¨×™×. ×œ×—×¥ ×¢×œ "×”×•×¡×£ ××•×¦×¨" ×œ×™×¦×™×¨×ª ××•×¦×¨ ×—×“×©.</p>';
                return;
            }
            
            grid.innerHTML = products.map(p => `
                <div class="product-card ${p.is_active ? '' : 'inactive'}">
                    ${p.image_url ? `<img src="${p.image_url}" alt="${p.name}" class="product-image">` : '<div class="product-image" style="display:flex;align-items:center;justify-content:center;font-size:4rem">' + (p.icon || 'ğŸ') + '</div>'}
                    <div class="product-content">
                        <div class="product-header">
                            <div class="product-name">${p.icon || 'ğŸ'} ${p.name}</div>
                            <div class="product-price">â‚ª${parseFloat(p.price).toLocaleString()}</div>
                        </div>
                        <div class="product-description">${p.description || ''}</div>
                        <div class="product-meta">
                            <span class="badge ${p.is_active ? 'badge-active' : 'badge-inactive'}">${p.is_active ? '×¤×¢×™×œ' : '×œ× ×¤×¢×™×œ'}</span>
                            ${p.is_premium ? '<span class="badge badge-premium">×¤×¨×™××™×•×</span>' : ''}
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-secondary btn-small" onclick="editProduct(${p.id})">×¢×¨×™×›×”</button>
                            <button class="btn btn-danger btn-small" onclick="deleteProduct(${p.id}, '${p.name}')">××—×™×§×”</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = '×”×•×¡×¤×ª ××•×¦×¨';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productActive').checked = true;
            selectEmoji('ğŸ');
            setImagePreview('');
            uploadedImageUrl = null;
            document.getElementById('productImage').classList.add('hidden');
            document.getElementById('productModal').classList.remove('hidden');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            document.getElementById('modalTitle').textContent = '×¢×¨×™×›×ª ××•×¦×¨';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productOrder').value = product.display_order || 0;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productPaymentUrl').value = product.payment_url || '';
            document.getElementById('productActive').checked = product.is_active;
            document.getElementById('productPremium').checked = product.is_premium;
            selectEmoji(product.icon || 'ğŸ');
            
            // Handle image
            setImagePreview(product.image_url || '');
            uploadedImageUrl = product.image_url && product.image_url.startsWith('/uploads/') ? product.image_url : null;
            document.getElementById('productImage').classList.add('hidden');
            
            document.getElementById('productModal').classList.remove('hidden');
        }

        function closeModal() {
            // If a new image was uploaded but not saved, delete it
            const productId = document.getElementById('productId').value;
            if (!productId && uploadedImageUrl && uploadedImageUrl.startsWith('/uploads/')) {
                const filename = uploadedImageUrl.split('/').pop();
                fetch(`${API}/upload/product-image/${filename}`, {
                    method: 'DELETE',
                    credentials: 'include'
                }).catch(console.error);
            }
            uploadedImageUrl = null;
            document.getElementById('productModal').classList.add('hidden');
        }

        async function saveProduct() {
            const id = document.getElementById('productId').value;
            const imageUrl = currentImageUrl || document.getElementById('productImage').value;
            const data = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                image_url: imageUrl,
                payment_url: document.getElementById('productPaymentUrl').value,
                display_order: parseInt(document.getElementById('productOrder').value) || 0,
                is_active: document.getElementById('productActive').checked,
                is_premium: document.getElementById('productPremium').checked,
                icon: selectedEmoji
            };
            
            try {
                const url = id ? `${API}/products/${id}` : `${API}/products`;
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    closeModal();
                    loadProducts();
                } else {
                    const err = await res.json();
                    alert(err.message || '×©×’×™××” ×‘×©××™×¨×ª ××•×¦×¨');
                }
            } catch (error) {
                alert('×©×’×™××” ×‘×©××™×¨×ª ××•×¦×¨');
            }
        }

        function deleteProduct(id, name) {
            deleteProductId = id;
            document.getElementById('deleteProductName').textContent = name;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deleteProductId = null;
        }

        async function confirmDelete() {
            if (!deleteProductId) return;
            
            try {
                const res = await fetch(`${API}/products/${deleteProductId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (res.ok) {
                    closeDeleteModal();
                    loadProducts();
                } else {
                    alert('×©×’×™××” ×‘××—×™×§×ª ××•×¦×¨');
                }
            } catch (error) {
                alert('×©×’×™××” ×‘××—×™×§×ª ××•×¦×¨');
            }
        }

        // Emoji picker
        document.querySelectorAll('.emoji-option').forEach(el => {
            el.addEventListener('click', () => selectEmoji(el.dataset.emoji));
        });

        function selectEmoji(emoji) {
            selectedEmoji = emoji;
            document.getElementById('productIcon').value = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.emoji === emoji);
            });
        }

        // Image upload handlers
        document.getElementById('imageFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            
            const container = document.querySelector('.image-upload-container');
            container.classList.add('uploading');
            
            try {
                const res = await fetch(`${API}/upload/product-image`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const data = await res.json();
                if (data.success) {
                    setImagePreview(data.imageUrl);
                    uploadedImageUrl = data.imageUrl;
                } else {
                    alert(data.message || '×©×’×™××” ×‘×”×¢×œ××”');
                }
            } catch (error) {
                alert('×©×’×™××” ×‘×”×¢×œ××ª ×”×ª××•× ×”');
            } finally {
                container.classList.remove('uploading');
                e.target.value = '';
            }
        });
        
        document.getElementById('productImage').addEventListener('input', (e) => {
            const url = e.target.value;
            if (url) {
                setImagePreview(url);
            }
        });
        
        function setImagePreview(url) {
            const preview = document.getElementById('imagePreview');
            const removeBtn = document.getElementById('removeImageBtn');
            
            if (url) {
                preview.innerHTML = `<img src="${url}" alt="×ª×¦×•×’×” ××§×“×™××”">`;
                removeBtn.classList.remove('hidden');
                document.getElementById('productImage').value = url;
                currentImageUrl = url;
            } else {
                preview.innerHTML = '<span class="no-image">××™×Ÿ ×ª××•× ×”</span>';
                removeBtn.classList.add('hidden');
                document.getElementById('productImage').value = '';
                currentImageUrl = '';
            }
        }
        
        function toggleUrlInput() {
            const input = document.getElementById('productImage');
            input.classList.toggle('hidden');
            if (!input.classList.contains('hidden')) {
                input.focus();
            }
        }
        
        function removeImage() {
            // If it was an uploaded image, delete it from server
            if (uploadedImageUrl && uploadedImageUrl.startsWith('/uploads/')) {
                const filename = uploadedImageUrl.split('/').pop();
                fetch(`${API}/upload/product-image/${filename}`, {
                    method: 'DELETE',
                    credentials: 'include'
                }).catch(console.error);
            }
            
            uploadedImageUrl = null;
            setImagePreview('');
        }
        
        function logout() {
            fetch(`${API}/auth/logout`, { method: 'POST', credentials: 'include' })
                .finally(() => window.location.href = '/admin/login');
        }
    </script>
</body>
</html>
