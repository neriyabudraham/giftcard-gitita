<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××©×ª××©×™× - ××¢×¨×›×ª ×©×•×‘×¨×™×</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Assistant', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: white;
        }
        .navbar {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .navbar-brand img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
        }
        .navbar-brand h1 {
            font-size: 1.3rem;
            color: #FFD700;
        }
        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-name { color: #ccc; }
        .nav-links {
            display: flex;
            gap: 15px;
        }
        .nav-link {
            color: #ccc;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,215,0,0.2);
            color: #FFD700;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-logout {
            background: rgba(220,53,69,0.3);
            color: #ff6b6b;
        }
        .btn-logout:hover { background: rgba(220,53,69,0.5); }
        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .btn-danger {
            background: rgba(220,53,69,0.3);
            color: #ff6b6b;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        .card-header {
            background: rgba(0,0,0,0.2);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2 {
            color: #FFD700;
            font-size: 1.3rem;
        }
        .card-body { padding: 25px; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background: rgba(0,0,0,0.2);
            color: #FFD700;
            font-weight: 600;
        }
        tr:hover { background: rgba(255,255,255,0.03); }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-active { background: rgba(40,167,69,0.2); color: #5cb85c; }
        .status-inactive { background: rgba(220,53,69,0.2); color: #ff6b6b; }
        .role-admin { background: rgba(255,215,0,0.2); color: #FFD700; }
        .role-user { background: rgba(100,100,100,0.2); color: #aaa; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { color: #FFD700; }
        .modal-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-body { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            color: #ddd;
            margin-bottom: 8px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }
        .actions-cell {
            display: flex;
            gap: 8px;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        .info-text {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #FFD700;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="https://files.neriyabudraham.co.il/files/save_IMG_0392_20250916_xhwpe.jpg" alt="×œ×•×’×•">
            <h1>× ×™×”×•×œ ××©×ª××©×™×</h1>
        </div>
        <div class="nav-links">
            <a href="/admin/" class="nav-link">×©×•×‘×¨×™×</a>
            <a href="/admin/products" class="nav-link">××•×¦×¨×™×</a>
            <a href="/admin/settings" class="nav-link">×”×’×“×¨×•×ª ××ª×¨</a>
            <a href="/admin/users" class="nav-link active">××©×ª××©×™×</a>
        </div>
        <div class="navbar-user">
            <span class="user-name" id="userName"></span>
            <button class="btn btn-logout" onclick="logout()">×”×ª× ×ª×§×•×ª</button>
        </div>
    </nav>

    <div class="container">
        <div class="info-text">
            ğŸ’¡ ×¨×§ ×× ×”×œ×™× ×™×›×•×œ×™× ×œ×”×•×¡×™×£ ××©×ª××©×™× ×—×“×©×™×. ××©×ª××© ×—×“×© ×™×§×‘×œ ×”×–×× ×” ×œ×™×¦×•×¨ ×¡×™×¡××” ×‘×”×ª×—×‘×¨×•×ª ×”×¨××©×•× ×”.
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>×¨×©×™××ª ××©×ª××©×™×</h2>
                <button class="btn btn-primary" onclick="openAddModal()">+ ×”×•×¡×£ ××©×ª××©</button>
            </div>
            <div class="card-body">
                <div id="usersTable">
                    <div class="loading">×˜×•×¢×Ÿ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×”×•×¡×¤×ª ××©×ª××© ×—×“×©</h3>
                <button class="modal-close" onclick="closeModal('addModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="form-group">
                        <label>××™××™×™×œ</label>
                        <input type="text" id="addEmail" required placeholder="example@domain.com">
                    </div>
                    <div class="form-group">
                        <label>×©×</label>
                        <input type="text" id="addName">
                    </div>
                    <div class="form-group">
                        <label>×”×¨×©××”</label>
                        <select id="addRole">
                            <option value="user">××©×ª××© ×¨×’×™×œ</option>
                            <option value="admin">×× ×”×œ</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">×”×•×¡×¤×ª ××©×ª××©</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×¢×¨×™×›×ª ××©×ª××©</h3>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label>××™××™×™×œ</label>
                        <input type="email" id="editEmail" readonly style="opacity:0.6">
                    </div>
                    <div class="form-group">
                        <label>×©×</label>
                        <input type="text" id="editName">
                    </div>
                    <div class="form-group">
                        <label>×”×¨×©××”</label>
                        <select id="editRole">
                            <option value="user">××©×ª××© ×¨×’×™×œ</option>
                            <option value="admin">×× ×”×œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>×¡×˜×˜×•×¡</label>
                        <select id="editActive">
                            <option value="true">×¤×¢×™×œ</option>
                            <option value="false">×œ× ×¤×¢×™×œ</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">×©××™×¨×ª ×©×™× ×•×™×™×</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let currentUser = null;
        let users = [];

        async function init() {
            try {
                const res = await fetch(`${API}/auth/me`, { credentials: 'include' });
                if (!res.ok) throw new Error('Not authenticated');
                
                const data = await res.json();
                currentUser = data.user;
                
                if (currentUser.role !== 'admin') {
                    window.location.href = '/admin/';
                    return;
                }
                
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                loadUsers();
                
            } catch (error) {
                window.location.href = '/admin/login';
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API}/users`, { credentials: 'include' });
                users = await res.json();
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTable').innerHTML = '<div class="loading">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</div>';
            }
        }

        function renderUsers() {
            if (users.length === 0) {
                document.getElementById('usersTable').innerHTML = '<div class="loading">××™×Ÿ ××©×ª××©×™×</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>××™××™×™×œ</th>
                            <th>×©×</th>
                            <th>×”×¨×©××”</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×¡×™×¡××” × ×•×¦×¨×”</th>
                            <th>×”×ª×—×‘×¨×•×ª ××—×¨×•× ×”</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(u => `
                            <tr>
                                <td>${u.email}</td>
                                <td>${u.name || '-'}</td>
                                <td><span class="status-badge ${u.role === 'admin' ? 'role-admin' : 'role-user'}">${u.role === 'admin' ? '×× ×”×œ' : '××©×ª××©'}</span></td>
                                <td><span class="status-badge ${u.is_active ? 'status-active' : 'status-inactive'}">${u.is_active ? '×¤×¢×™×œ' : '×œ× ×¤×¢×™×œ'}</span></td>
                                <td>${u.password_created ? 'âœ“' : 'âœ—'}</td>
                                <td>${u.last_login ? new Date(u.last_login).toLocaleString('he-IL') : '××£ ×¤×¢×'}</td>
                                <td class="actions-cell">
                                    <button class="btn btn-sm btn-secondary" onclick="openEditModal(${u.id})">×¢×¨×™×›×”</button>
                                    ${u.id !== currentUser.id ? `
                                        <button class="btn btn-sm btn-secondary" onclick="forceReset(${u.id})">××™×¤×•×¡ ×¡×™×¡××”</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">××—×™×§×”</button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            
            document.getElementById('usersTable').innerHTML = html;
        }

        function openAddModal() {
            document.getElementById('addForm').reset();
            document.getElementById('addModal').classList.add('show');
        }

        function openEditModal(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('editId').value = user.id;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editName').value = user.name || '';
            document.getElementById('editRole').value = user.role;
            document.getElementById('editActive').value = String(user.is_active);
            
            document.getElementById('editModal').classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = {
                email: document.getElementById('addEmail').value,
                name: document.getElementById('addName').value,
                role: document.getElementById('addRole').value
            };
            
            try {
                const res = await fetch(`${API}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(user)
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message);
                
                alert('××©×ª××© × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                closeModal('addModal');
                loadUsers();
                
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const user = {
                name: document.getElementById('editName').value,
                role: document.getElementById('editRole').value,
                is_active: document.getElementById('editActive').value === 'true'
            };
            
            try {
                const res = await fetch(`${API}/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(user)
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message);
                
                alert('××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
                closeModal('editModal');
                loadUsers();
                
            } catch (error) {
                alert(error.message);
            }
        });

        async function forceReset(id) {
            if (!confirm('×”×× ×œ××¤×¡ ××ª ×”×¡×™×¡××” ×œ××©×ª××© ×–×”?')) return;
            
            try {
                const res = await fetch(`${API}/users/${id}/force-reset`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message);
                
                alert(data.message);
                loadUsers();
                
            } catch (error) {
                alert(error.message);
            }
        }

        async function deleteUser(id) {
            if (!confirm('×”×× ×œ××—×•×§ ××©×ª××© ×–×”? ×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) return;
            
            try {
                const res = await fetch(`${API}/users/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.message);
                }
                
                alert('××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”!');
                loadUsers();
                
            } catch (error) {
                alert(error.message);
            }
        }

        async function logout() {
            try {
                await fetch(`${API}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch {}
            window.location.href = '/admin/login';
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal.id);
            });
        });

        init();
    </script>
</body>
</html>
