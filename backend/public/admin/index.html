<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×©×•×‘×¨×™× - ×©×¤×ª ×”××“×‘×¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Assistant', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: white;
        }
        .navbar {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .navbar-brand img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
        }
        .navbar-brand h1 {
            font-size: 1.3rem;
            color: #FFD700;
        }
        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-name { color: #ccc; }
        .nav-links {
            display: flex;
            gap: 15px;
        }
        .nav-link {
            color: #ccc;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,215,0,0.2);
            color: #FFD700;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-logout {
            background: rgba(220,53,69,0.3);
            color: #ff6b6b;
        }
        .btn-logout:hover { background: rgba(220,53,69,0.5); }
        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .btn-success {
            background: rgba(40,167,69,0.3);
            color: #5cb85c;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-card h3 {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #FFD700;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        .card-header {
            background: rgba(0,0,0,0.2);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2 {
            color: #FFD700;
            font-size: 1.3rem;
        }
        .card-body { padding: 25px; }
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-bar input, .search-bar select {
            padding: 12px 18px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }
        .search-bar input::placeholder { color: #888; }
        .search-bar input:focus, .search-bar select:focus {
            outline: none;
            border-color: #FFD700;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background: rgba(0,0,0,0.2);
            color: #FFD700;
            font-weight: 600;
        }
        tr:hover { background: rgba(255,255,255,0.03); }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-active { background: rgba(40,167,69,0.2); color: #5cb85c; }
        .status-used { background: rgba(108,117,125,0.2); color: #aaa; }
        .status-expired { background: rgba(220,53,69,0.2); color: #ff6b6b; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .modal-content {
            background: #1a1a2e;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { color: #FFD700; }
        .modal-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-body { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            color: #ddd;
            margin-bottom: 8px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .voucher-details {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .voucher-details p {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        .voucher-details strong { color: #FFD700; }
        .actions-cell {
            display: flex;
            gap: 8px;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        @media (max-width: 768px) {
            .navbar { flex-direction: column; gap: 15px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            table { font-size: 0.85rem; }
            th, td { padding: 10px 8px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="https://files.neriyabudraham.co.il/files/save_IMG_0392_20250916_xhwpe.jpg" alt="Logo">
            <h1>××¢×¨×›×ª × ×™×”×•×œ ×©×•×‘×¨×™×</h1>
        </div>
        <div class="navbar-user">
            <div class="nav-links">
                <a href="/admin/" class="nav-link active">×©×•×‘×¨×™×</a>
                <a href="/admin/leads" class="nav-link">×œ×™×“×™×</a>
                <a href="/admin/products" class="nav-link">××•×¦×¨×™×</a>
                <a href="/admin/settings" class="nav-link">×”×’×“×¨×•×ª</a>
                <a href="/admin/users" class="nav-link" id="usersLink" style="display:none">××©×ª××©×™×</a>
            </div>
            <span class="user-name" id="userName"></span>
            <button class="btn btn-logout" onclick="logout()">×™×¦×™××”</button>
        </div>
    </nav>

    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>×¡×”"×› ×©×•×‘×¨×™×</h3>
                <div class="value" id="totalVouchers">-</div>
            </div>
            <div class="stat-card">
                <h3>×©×•×‘×¨×™× ×¤×¢×™×œ×™×</h3>
                <div class="value" id="activeVouchers">-</div>
            </div>
            <div class="stat-card">
                <h3>×©×•×‘×¨×™× ×©× ×•×¦×œ×•</h3>
                <div class="value" id="usedVouchers">-</div>
            </div>
            <div class="stat-card">
                <h3>×¡×›×•× ×›×•×œ×œ ×¤×¢×™×œ</h3>
                <div class="value" id="totalAmount">-</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>×¨×©×™××ª ×©×•×‘×¨×™×</h2>
                <button class="btn btn-primary" onclick="openCreateModal()">+ ×©×•×‘×¨ ×—×“×©</button>
            </div>
            <div class="card-body">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="×—×™×¤×•×© ×œ×¤×™ ××¡×¤×¨ / ×©× / ×˜×œ×¤×•×Ÿ...">
                    <select id="statusFilter">
                        <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                        <option value="active">×¤×¢×™×œ</option>
                        <option value="used">× ×•×¦×œ</option>
                        <option value="expired">×¤×’ ×ª×•×§×£</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadVouchers()">×—×™×¤×•×©</button>
                </div>
                <div id="vouchersTable">
                    <div class="loading">×˜×•×¢×Ÿ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Use Voucher Modal -->
    <div class="modal" id="useModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×©×™××•×© ×‘×©×•×‘×¨</h3>
                <button class="modal-close" onclick="closeModal('useModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="voucher-details" id="useVoucherDetails"></div>
                <form id="useForm">
                    <input type="hidden" id="useVoucherId">
                    <div class="form-group" id="useAmountGroup">
                        <label>×¡×›×•× ×œ× ×™×¦×•×œ</label>
                        <input type="number" id="useAmount" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
                        <textarea id="useNotes" placeholder="×”×¢×¨×•×ª ×œ×¨×™×©×•×..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">××™×©×•×¨ ×©×™××•×©</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Voucher Modal -->
    <div class="modal" id="editVoucherModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×¢×¨×™×›×ª ×©×•×‘×¨</h3>
                <button class="modal-close" onclick="closeModal('editVoucherModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editVoucherForm">
                    <input type="hidden" id="editVoucherId">
                    <div class="form-group">
                        <label>××¡×¤×¨ ×©×•×‘×¨</label>
                        <input type="text" id="editVoucherNumber" readonly style="opacity:0.7">
                    </div>
                    <div class="form-group">
                        <label>×©× ×œ×§×•×—</label>
                        <input type="text" id="editCustomerName">
                    </div>
                    <div class="form-group">
                        <label>×˜×œ×¤×•×Ÿ</label>
                        <input type="tel" id="editPhoneNumber">
                    </div>
                    <div class="form-group">
                        <label>×¡×›×•× ××§×•×¨×™</label>
                        <input type="number" id="editOriginalAmount" readonly style="opacity:0.7">
                    </div>
                    <div class="form-group">
                        <label>×™×ª×¨×” × ×•×›×—×™×ª</label>
                        <input type="number" id="editRemainingAmount" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>×ª××¨×™×š ×ª×¤×•×’×”</label>
                        <input type="date" id="editExpiryDate">
                    </div>
                    <div class="form-group">
                        <label>×¡×˜×˜×•×¡</label>
                        <select id="editStatus">
                            <option value="active">×¤×¢×™×œ</option>
                            <option value="used">× ×•×¦×œ</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editVoucherModal')" style="flex:1">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary" style="flex:1">×©××•×¨ ×©×™× ×•×™×™×</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Voucher Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header">
                <h3>×™×¦×™×¨×ª ×©×•×‘×¨ ×—×“×©</h3>
                <button class="modal-close" onclick="closeModal('createModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <!-- Product Selection -->
                    <div class="form-group" style="margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1)">
                        <label style="font-weight:600;color:#FFD700">×‘×—×™×¨×ª ××•×¦×¨ ××”×§×˜×œ×•×’</label>
                        <select id="createProductSelect" onchange="selectProduct()" style="width:100%;padding:12px;margin-top:8px">
                            <option value="">-- ×‘×—×¨ ××•×¦×¨ ××• ×”×–×Ÿ ×™×“× ×™×ª --</option>
                        </select>
                    </div>
                    
                    <!-- Voucher Details -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
                        <div class="form-group">
                            <label>××¡×¤×¨ ×©×•×‘×¨ (13 ×¡×¤×¨×•×ª)</label>
                            <input type="text" id="createNumber" pattern="\d{13}" required placeholder="×™×•×•×¦×¨ ××•×˜×•××˜×™×ª">
                            <button type="button" class="btn btn-sm btn-secondary" style="margin-top:8px" onclick="generateVoucherNumber()">×¦×•×¨ ××¡×¤×¨</button>
                        </div>
                        <div class="form-group">
                            <label>×¡×•×’ ×©×•×‘×¨</label>
                            <select id="createVoucherType" onchange="toggleProductName()">
                                <option value="monetary">×©×•×‘×¨ ×›×¡×¤×™ (×¡×›×•×)</option>
                                <option value="product">×©×•×‘×¨ ××•×¦×¨</option>
                            </select>
                        </div>
                        <div class="form-group" id="amountGroup">
                            <label>×¡×›×•×</label>
                            <input type="number" id="createAmount" min="1" required>
                        </div>
                        <div class="form-group" id="productNameGroup" style="display:none">
                            <label>×©× ×”××•×¦×¨</label>
                            <input type="text" id="createProductName" placeholder="×œ×“×•×’××”: ×§×¤×” ×××¤×” ×–×•×’×™ + ×¢×¦×™×¥">
                        </div>
                        <div class="form-group">
                            <label>×ª××¨×™×š ×ª×¤×•×’×”</label>
                            <input type="date" id="createExpiry">
                        </div>
                    </div>
                    
                    <!-- Buyer Details -->
                    <div style="background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.2);border-radius:10px;padding:15px;margin-bottom:15px">
                        <h4 style="color:#FFD700;margin-bottom:12px;font-size:1rem">×¤×¨×˜×™ ×”×¨×•×›×© (××•×¤×¦×™×•× ×œ×™)</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="font-size:0.85rem">×©×</label>
                                <input type="text" id="createBuyerName" placeholder="×©× ×”×¨×•×›×©">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="font-size:0.85rem">×˜×œ×¤×•×Ÿ</label>
                                <input type="tel" id="createBuyerPhone" placeholder="×˜×œ×¤×•×Ÿ">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="font-size:0.85rem">××™××™×™×œ</label>
                                <input type="email" id="createBuyerEmail" placeholder="××™×™×œ ×”×¨×•×›×©">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recipient Details -->
                    <div style="background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.2);border-radius:10px;padding:15px;margin-bottom:15px">
                        <h4 style="color:#22c55e;margin-bottom:12px;font-size:1rem">×¤×¨×˜×™ ××§×‘×œ ×”×©×•×‘×¨ (××•×¤×¦×™×•× ×œ×™)</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="font-size:0.85rem">×©×</label>
                                <input type="text" id="createRecipientName" placeholder="×©× ×”××§×‘×œ">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="font-size:0.85rem">×˜×œ×¤×•×Ÿ</label>
                                <input type="tel" id="createRecipientPhone" placeholder="×˜×œ×¤×•×Ÿ">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="font-size:0.85rem">××™××™×™×œ</label>
                                <input type="email" id="createRecipientEmail" placeholder="××™×™×œ ×”××§×‘×œ">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Greeting -->
                    <div class="form-group">
                        <label>×‘×¨×›×” ×¢×œ ×”×©×•×‘×¨</label>
                        <textarea id="createGreeting" placeholder="×‘×¨×›×” ××™×©×™×ª ×©×ª×•×¤×™×¢ ×¢×œ ×”×©×•×‘×¨..." style="min-height:100px"></textarea>
                    </div>
                    
                    <!-- Email Options -->
                    <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:15px;margin-bottom:15px">
                        <h4 style="color:#ccc;margin-bottom:12px;font-size:1rem">××¤×©×¨×•×™×•×ª ×©×œ×™×—×ª ××™×™×œ</h4>
                        <div style="display:flex;flex-wrap:wrap;gap:20px">
                            <div style="display:flex;align-items:center;gap:8px">
                                <input type="checkbox" id="createSendToAdmin" checked>
                                <label for="createSendToAdmin" style="margin:0;cursor:pointer;font-size:0.9rem">×©×œ×— ×œ×× ×”×œ</label>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <input type="checkbox" id="createSendToBuyer" checked>
                                <label for="createSendToBuyer" style="margin:0;cursor:pointer;font-size:0.9rem">×©×œ×— ×œ×¨×•×›×©</label>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <input type="checkbox" id="createSendToRecipient" checked>
                                <label for="createSendToRecipient" style="margin:0;cursor:pointer;font-size:0.9rem">×©×œ×— ×œ××§×‘×œ</label>
                            </div>
                        </div>
                        <p style="color:#888;font-size:0.8rem;margin-top:8px">* ××™×™×œ×™× ×™×™×©×œ×—×• ×¨×§ ×× ×™×© ×›×ª×•×‘×ª ××™×™×œ ×ª×§×™× ×”</p>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width:100%">×™×¦×™×¨×ª ×©×•×‘×¨</button>
                </form>
            </div>
        </div>
    </div>

    <!-- View Voucher Modal -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×¤×¨×˜×™ ×©×•×‘×¨</h3>
                <button class="modal-close" onclick="closeModal('viewModal')">&times;</button>
            </div>
            <div class="modal-body" id="viewModalBody"></div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content" style="max-width:450px;text-align:center">
            <div class="modal-body" style="padding:40px 30px">
                <div id="successIcon" style="font-size:4rem;margin-bottom:20px">âœ…</div>
                <h2 id="successTitle" style="color:#22c55e;margin-bottom:15px">×©×•×‘×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!</h2>
                <p id="successMessage" style="color:#ccc;font-size:1.1rem;line-height:1.6;margin-bottom:25px"></p>
                <div id="successDetails" style="background:rgba(34,197,94,0.1);border-radius:10px;padding:15px;margin-bottom:25px;text-align:right"></div>
                <button class="btn btn-primary" onclick="closeModal('successModal')" style="min-width:150px">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal" id="errorModal">
        <div class="modal-content" style="max-width:450px;text-align:center">
            <div class="modal-body" style="padding:40px 30px">
                <div style="font-size:4rem;margin-bottom:20px">âŒ</div>
                <h2 style="color:#ef4444;margin-bottom:15px">×©×’×™××”</h2>
                <p id="errorMessage" style="color:#ccc;font-size:1.1rem;line-height:1.6;margin-bottom:25px"></p>
                <button class="btn btn-secondary" onclick="closeModal('errorModal')" style="min-width:150px">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let currentUser = null;
        let vouchers = [];

        async function init() {
            try {
                const res = await fetch(`${API}/auth/me`, { credentials: 'include' });
                if (!res.ok) throw new Error('Not authenticated');
                
                const data = await res.json();
                currentUser = data.user;
                
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                
                if (currentUser.role === 'admin') {
                    document.getElementById('usersLink').style.display = 'block';
                }
                
                if (currentUser.password_reset_required) {
                    window.location.href = '/admin/create-password?reset=true';
                    return;
                }
                
                // Check for search parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const searchParam = urlParams.get('search');
                if (searchParam) {
                    document.getElementById('searchInput').value = searchParam;
                }
                
                loadVouchers();
                loadStats();
                
            } catch (error) {
                window.location.href = '/admin/login';
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API}/vouchers?limit=1000`, { credentials: 'include' });
                const data = await res.json();
                
                const total = data.total || 0;
                const active = data.vouchers.filter(v => v.status === 'active').length;
                const used = data.vouchers.filter(v => v.status === 'used').length;
                const totalAmount = data.vouchers
                    .filter(v => v.status === 'active')
                    .reduce((sum, v) => sum + parseFloat(v.remaining_amount || 0), 0);
                
                document.getElementById('totalVouchers').textContent = total;
                document.getElementById('activeVouchers').textContent = active;
                document.getElementById('usedVouchers').textContent = used;
                document.getElementById('totalAmount').textContent = 'â‚ª' + (Number.isInteger(totalAmount) ? totalAmount : totalAmount.toLocaleString());
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadVouchers() {
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            
            let url = `${API}/vouchers?`;
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (status) url += `status=${status}&`;
            
            try {
                const res = await fetch(url, { credentials: 'include' });
                const data = await res.json();
                
                vouchers = data.vouchers;
                renderVouchers();
                
            } catch (error) {
                console.error('Error loading vouchers:', error);
                document.getElementById('vouchersTable').innerHTML = '<div class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</div>';
            }
        }

        function renderVouchers() {
            if (vouchers.length === 0) {
                document.getElementById('vouchersTable').innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        </svg>
                        <p>××™×Ÿ ×©×•×‘×¨×™× ×œ×”×¦×’×”</p>
                    </div>`;
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>××¡×¤×¨ ×©×•×‘×¨</th>
                            <th>×©× ×œ×§×•×—</th>
                            <th>×¡×›×•× ××§×•×¨×™</th>
                            <th>×™×ª×¨×”</th>
                            <th>×ª××¨×™×š ×ª×¤×•×’×”</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${vouchers.map(v => {
                            const isExpired = v.expiry_date && new Date(v.expiry_date) < new Date();
                            const statusClass = v.status === 'used' ? 'status-used' : 
                                               (isExpired ? 'status-expired' : 'status-active');
                            const statusText = v.status === 'used' ? '× ×•×¦×œ' : 
                                              (isExpired ? '×¤×’ ×ª×•×§×£' : '×¤×¢×™×œ');
                            return `
                                <tr>
                                    <td><strong>${v.voucher_number}</strong></td>
                                    <td>${v.customer_name || '-'}</td>
                                    <td>â‚ª${Number.isInteger(parseFloat(v.original_amount)) ? parseInt(v.original_amount) : parseFloat(v.original_amount).toLocaleString()}</td>
                                    <td>â‚ª${Number.isInteger(parseFloat(v.remaining_amount)) ? parseInt(v.remaining_amount) : parseFloat(v.remaining_amount).toLocaleString()}</td>
                                    <td>${v.expiry_date ? new Date(v.expiry_date).toLocaleDateString('he-IL') : '-'}</td>
                                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                    <td class="actions-cell">
                                        <button class="btn btn-sm btn-secondary" onclick="viewVoucher(${v.id})">×¦×¤×™×™×”</button>
                                        <button class="btn btn-sm btn-primary" onclick="downloadVoucher('${v.voucher_number}')" title="×”×•×¨×“×”">â¬‡</button>
                                        ${v.status === 'active' && !isExpired ? 
                                            `<button class="btn btn-sm btn-success" onclick="openUseModal(${v.id})">×©×™××•×©</button>` : ''}
                                        <button class="btn btn-sm" style="background:rgba(255,193,7,0.2);color:#ffc107" onclick="openEditVoucherModal(${v.id})" title="×¢×¨×™×›×”">âœï¸</button>
                                        <button class="btn btn-sm" style="background:rgba(220,53,69,0.2);color:#dc3545" onclick="deleteVoucher(${v.id})" title="××—×™×§×”">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>`;
                        }).join('')}
                    </tbody>
                </table>`;
            
            document.getElementById('vouchersTable').innerHTML = html;
        }

        function openUseModal(id) {
            const voucher = vouchers.find(v => v.id === id);
            if (!voucher) return;
            
            const isProductVoucher = voucher.product_name && voucher.product_name.length > 0;
            const amountInput = document.getElementById('useAmount');
            const amountGroup = document.getElementById('useAmountGroup');
            
            document.getElementById('useVoucherId').value = id;
            amountInput.max = voucher.remaining_amount;
            document.getElementById('useNotes').value = '';
            
            if (isProductVoucher) {
                // Product vouchers - hide amount field, auto-set full amount
                amountGroup.style.display = 'none';
                amountInput.value = voucher.remaining_amount;
                amountInput.required = false;
                document.getElementById('useVoucherDetails').innerHTML = `
                    <p><span>××¡×¤×¨ ×©×•×‘×¨:</span> <strong>${voucher.voucher_number}</strong></p>
                    <p><span>×©× ×œ×§×•×—:</span> <strong>${voucher.customer_name || '-'}</strong></p>
                    <p><span>××•×¦×¨:</span> <strong>${voucher.product_name}</strong></p>
                `;
            } else {
                amountGroup.style.display = 'block';
                amountInput.value = '';
                amountInput.required = true;
                document.getElementById('useVoucherDetails').innerHTML = `
                    <p><span>××¡×¤×¨ ×©×•×‘×¨:</span> <strong>${voucher.voucher_number}</strong></p>
                    <p><span>×©× ×œ×§×•×—:</span> <strong>${voucher.customer_name || '-'}</strong></p>
                    <p><span>×™×ª×¨×” × ×•×›×—×™×ª:</span> <strong>â‚ª${Number.isInteger(parseFloat(voucher.remaining_amount)) ? parseInt(voucher.remaining_amount) : parseFloat(voucher.remaining_amount).toLocaleString()}</strong></p>
                `;
            }
            
            document.getElementById('useModal').classList.add('show');
        }

        function toggleProductName() {
            const type = document.getElementById('createVoucherType').value;
            const amountGroup = document.getElementById('amountGroup');
            const productNameGroup = document.getElementById('productNameGroup');
            
            if (type === 'product') {
                amountGroup.style.display = 'none';
                productNameGroup.style.display = 'block';
                document.getElementById('createAmount').required = false;
                document.getElementById('createProductName').required = true;
            } else {
                amountGroup.style.display = 'block';
                productNameGroup.style.display = 'none';
                document.getElementById('createAmount').required = true;
                document.getElementById('createProductName').required = false;
            }
        }

        let productsCache = [];
        
        async function loadProductsForCreate() {
            try {
                const res = await fetch(`${API}/products`, { credentials: 'include' });
                const data = await res.json();
                productsCache = Array.isArray(data) ? data : (data.products || []);
                
                const select = document.getElementById('createProductSelect');
                select.innerHTML = '<option value="">-- ×‘×—×¨ ××•×¦×¨ ××• ×”×–×Ÿ ×™×“× ×™×ª --</option>';
                
                productsCache.filter(p => p.is_active !== false).forEach(p => {
                    const price = Number.isInteger(p.price) ? p.price : parseFloat(p.price).toFixed(0);
                    const isMonetary = p.name.includes('â‚ª') || p.name.includes('×©×•×‘×¨');
                    select.innerHTML += `<option value="${p.id}" data-price="${p.price}" data-name="${p.name}" data-monetary="${isMonetary}">${p.name} - â‚ª${price}</option>`;
                });
            } catch (e) {
                console.error('Error loading products:', e);
            }
        }
        
        function selectProduct() {
            const select = document.getElementById('createProductSelect');
            const option = select.options[select.selectedIndex];
            
            if (!option.value) return;
            
            const price = parseFloat(option.dataset.price);
            const name = option.dataset.name;
            const isMonetary = option.dataset.monetary === 'true';
            
            if (isMonetary) {
                document.getElementById('createVoucherType').value = 'monetary';
                document.getElementById('createAmount').value = price;
            } else {
                document.getElementById('createVoucherType').value = 'product';
                document.getElementById('createProductName').value = name;
                document.getElementById('createAmount').value = price;
            }
            
            toggleProductName();
        }

        function openCreateModal() {
            document.getElementById('createForm').reset();
            generateVoucherNumber();
            toggleProductName();
            
            // Load products
            loadProductsForCreate();
            
            // Set default expiry date to 1 year from now
            const expiryDate = new Date();
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
            document.getElementById('createExpiry').value = expiryDate.toISOString().split('T')[0];
            
            // Load default greeting
            loadDefaultGreeting();
            
            document.getElementById('createModal').classList.add('show');
        }
        
        async function loadDefaultGreeting() {
            try {
                const res = await fetch(`${API}/settings/public`);
                const settings = await res.json();
                if (settings.default_greeting) {
                    document.getElementById('createGreeting').value = settings.default_greeting;
                }
            } catch (e) {}
        }

        async function viewVoucher(id) {
            try {
                const res = await fetch(`${API}/vouchers/${id}`, { credentials: 'include' });
                const data = await res.json();
                
                const v = data.voucher;
                const history = data.usage_history || [];
                
                const isExpired = v.expiry_date && new Date(v.expiry_date) < new Date();
                
                document.getElementById('viewModalBody').innerHTML = `
                    <div class="voucher-details">
                        <p><span>××¡×¤×¨ ×©×•×‘×¨:</span> <strong>${v.voucher_number}</strong></p>
                        <p><span>×©× ×œ×§×•×—:</span> <strong>${v.customer_name || '-'}</strong></p>
                        <p><span>×˜×œ×¤×•×Ÿ:</span> <strong>${v.phone_number || '-'}</strong></p>
                        <p><span>××™××™×™×œ:</span> <strong>${v.email || '-'}</strong></p>
                        <p><span>×¡×›×•× ××§×•×¨×™:</span> <strong>â‚ª${Number.isInteger(parseFloat(v.original_amount)) ? parseInt(v.original_amount) : parseFloat(v.original_amount).toLocaleString()}</strong></p>
                        <p><span>×™×ª×¨×”:</span> <strong>â‚ª${Number.isInteger(parseFloat(v.remaining_amount)) ? parseInt(v.remaining_amount) : parseFloat(v.remaining_amount).toLocaleString()}</strong></p>
                        <p><span>×ª××¨×™×š ×¨×›×™×©×”:</span> <strong>${v.purchase_date ? new Date(v.purchase_date).toLocaleDateString('he-IL') : '-'}</strong></p>
                        <p><span>×ª×•×§×£:</span> <strong>${v.expiry_date ? new Date(v.expiry_date).toLocaleDateString('he-IL') : '-'}</strong></p>
                        <p><span>×¡×˜×˜×•×¡:</span> <strong>${v.status === 'used' ? '× ×•×¦×œ' : (isExpired ? '×¤×’ ×ª×•×§×£' : '×¤×¢×™×œ')}</strong></p>
                        ${v.greeting ? `<p><span>×‘×¨×›×”:</span> <strong>${v.greeting}</strong></p>` : ''}
                    </div>
                    ${history.length > 0 ? `
                        <h4 style="color:#FFD700;margin-bottom:15px">×”×™×¡×˜×•×¨×™×™×ª ×©×™××•×©</h4>
                        <table>
                            <thead><tr><th>×ª××¨×™×š</th><th>×¡×›×•×</th><th>×™×ª×¨×” ××—×¨×™</th><th>×‘×•×¦×¢ ×¢"×™</th></tr></thead>
                            <tbody>
                                ${history.map(h => `
                                    <tr>
                                        <td>${new Date(h.created_at).toLocaleString('he-IL')}</td>
                                        <td>â‚ª${parseFloat(h.amount_used).toLocaleString()}</td>
                                        <td>â‚ª${parseFloat(h.remaining_after).toLocaleString()}</td>
                                        <td>${h.used_by_name || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                `;
                
                document.getElementById('viewModal').classList.add('show');
                
            } catch (error) {
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×©×•×‘×¨');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        function showSuccessModal({ title, message, details }) {
            document.getElementById('successTitle').textContent = title || '×”×¦×œ×—×”!';
            document.getElementById('successMessage').textContent = message || '';
            document.getElementById('successDetails').innerHTML = details || '';
            document.getElementById('successDetails').style.display = details ? 'block' : 'none';
            document.getElementById('successModal').classList.add('show');
        }
        
        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message || '××™×¨×¢×” ×©×’×™××”';
            document.getElementById('errorModal').classList.add('show');
        }

        function generateVoucherNumber() {
            const num = Math.floor(Math.random() * 9000000000000) + 1000000000000;
            document.getElementById('createNumber').value = num.toString();
        }

        document.getElementById('useForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('useVoucherId').value;
            const amount = parseFloat(document.getElementById('useAmount').value);
            const notes = document.getElementById('useNotes').value;
            
            try {
                const res = await fetch(`${API}/vouchers/${id}/use`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ amount, notes })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message);
                
                alert(`×©×™××•×© × ×¨×©× ×‘×”×¦×œ×—×”!\n×¡×›×•×: â‚ª${amount}\n×™×ª×¨×” ×—×“×©×”: â‚ª${data.remaining_amount}`);
                closeModal('useModal');
                loadVouchers();
                loadStats();
                
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const voucherType = document.getElementById('createVoucherType').value;
            const isProductVoucher = voucherType === 'product';
            
            const buyerEmail = document.getElementById('createBuyerEmail').value;
            const recipientEmail = document.getElementById('createRecipientEmail').value;
            const voucherNumber = document.getElementById('createNumber').value;
            
            const amountValue = parseFloat(document.getElementById('createAmount').value) || 0;
            
            const voucher = {
                voucher_number: voucherNumber,
                original_amount: amountValue,
                expiry_date: document.getElementById('createExpiry').value,
                greeting: document.getElementById('createGreeting').value,
                product_name: isProductVoucher ? document.getElementById('createProductName').value : null,
                is_product_voucher: isProductVoucher,
                // Buyer details
                buyer_name: document.getElementById('createBuyerName').value,
                buyer_phone: document.getElementById('createBuyerPhone').value,
                buyer_email: buyerEmail,
                // Recipient details
                recipient_name: document.getElementById('createRecipientName').value,
                recipient_phone: document.getElementById('createRecipientPhone').value,
                email: recipientEmail,
                // For backward compatibility
                customer_name: document.getElementById('createRecipientName').value || document.getElementById('createBuyerName').value,
                phone_number: document.getElementById('createRecipientPhone').value || document.getElementById('createBuyerPhone').value,
                // Email options
                send_to_admin: document.getElementById('createSendToAdmin').checked,
                send_to_buyer: document.getElementById('createSendToBuyer').checked,
                send_to_recipient: document.getElementById('createSendToRecipient').checked
            };
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span style="display:inline-block;animation:spin 1s linear infinite">â³</span> ×™×•×¦×¨ ×©×•×‘×¨...';
            submitBtn.disabled = true;
            
            try {
                const res = await fetch(`${API}/vouchers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(voucher)
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message);
                
                // Build success message
                const sentTo = [];
                if (voucher.send_to_admin) sentTo.push('×× ×”×œ');
                if (voucher.send_to_buyer && buyerEmail) sentTo.push('×¨×•×›×©');
                if (voucher.send_to_recipient && recipientEmail) sentTo.push('××§×‘×œ');
                
                // Show success modal
                closeModal('createModal');
                showSuccessModal({
                    title: '×©×•×‘×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!',
                    message: sentTo.length > 0 ? '×”×©×•×‘×¨ × ×©×œ×— ×‘×”×¦×œ×—×”' : '×”×©×•×‘×¨ × ×©××¨ ×‘××¢×¨×›×ª',
                    details: `
                        <p><strong>××¡×¤×¨ ×©×•×‘×¨:</strong> ${voucherNumber}</p>
                        <p><strong>×¡×›×•×/××•×¦×¨:</strong> ${voucher.product_name || 'â‚ª' + voucher.original_amount}</p>
                        ${sentTo.length > 0 ? `<p><strong>× ×©×œ×— ×œ:</strong> ${sentTo.join(', ')}</p>` : ''}
                        ${buyerEmail && voucher.send_to_buyer ? `<p style="font-size:0.9rem;color:#888">×¨×•×›×©: ${buyerEmail}</p>` : ''}
                        ${recipientEmail && voucher.send_to_recipient ? `<p style="font-size:0.9rem;color:#888">××§×‘×œ: ${recipientEmail}</p>` : ''}
                    `
                });
                
                loadVouchers();
                loadStats();
                
            } catch (error) {
                showErrorModal(error.message);
            } finally {
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });

        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') loadVouchers();
        });

        async function downloadVoucher(voucherNumber) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API}/voucher/${voucherNumber}/generate`, { credentials: 'include' });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `voucher-${voucherNumber}.png`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    alert(errorData.message || '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×©×•×‘×¨');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('×©×’×™××” ×‘×”×•×¨×“×”');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function logout() {
            try {
                await fetch(`${API}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch {}
            window.location.href = '/admin/login';
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal.id);
            });
        });

        // Edit voucher functions
        function openEditVoucherModal(id) {
            const voucher = vouchers.find(v => v.id === id);
            if (!voucher) return;
            
            document.getElementById('editVoucherId').value = id;
            document.getElementById('editVoucherNumber').value = voucher.voucher_number;
            document.getElementById('editCustomerName').value = voucher.customer_name || '';
            document.getElementById('editPhoneNumber').value = voucher.phone_number || '';
            document.getElementById('editOriginalAmount').value = voucher.original_amount;
            document.getElementById('editRemainingAmount').value = voucher.remaining_amount;
            document.getElementById('editExpiryDate').value = voucher.expiry_date ? voucher.expiry_date.split('T')[0] : '';
            document.getElementById('editStatus').value = voucher.status;
            
            document.getElementById('editVoucherModal').classList.add('show');
        }

        document.getElementById('editVoucherForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editVoucherId').value;
            const data = {
                customer_name: document.getElementById('editCustomerName').value,
                phone_number: document.getElementById('editPhoneNumber').value,
                remaining_amount: parseFloat(document.getElementById('editRemainingAmount').value),
                expiry_date: document.getElementById('editExpiryDate').value || null,
                status: document.getElementById('editStatus').value
            };
            
            try {
                const res = await fetch(`${API}/vouchers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                
                if (result.success) {
                    closeModal('editVoucherModal');
                    loadVouchers();
                    loadStats();
                    showNotification('×”×©×•×‘×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
                } else {
                    alert(result.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ');
                }
            } catch (error) {
                console.error('Edit voucher error:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×©×•×‘×¨');
            }
        });

        async function deleteVoucher(id) {
            const voucher = vouchers.find(v => v.id === id);
            if (!voucher) return;
            
            if (!confirm(`×”×× ×œ××—×•×§ ××ª ×©×•×‘×¨ ${voucher.voucher_number}?\n\n×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API}/vouchers/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const result = await res.json();
                
                if (result.success) {
                    loadVouchers();
                    loadStats();
                    showNotification('×”×©×•×‘×¨ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                } else {
                    alert(result.message || '×©×’×™××” ×‘××—×™×§×”');
                }
            } catch (error) {
                console.error('Delete voucher error:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×©×•×‘×¨');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                padding: 15px 30px; border-radius: 10px; z-index: 10000;
                background: ${type === 'success' ? 'rgba(34,197,94,0.9)' : 'rgba(59,130,246,0.9)'};
                color: white; font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        init();
    </script>
</body>
</html>
